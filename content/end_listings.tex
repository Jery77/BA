% !TeX spellcheck = en_US
\allowdisplaybreaks
\chapter*{Listings}\label{chap:listing}
%TODO correct listings
\begin{Listing} 
	\caption{Generate the Artifact Type definition for scripts}
	\label{lst:scripttype}
\begin{lstlisting}
public class RR_ScriptArtifactType {

@XmlRootElement(name = "tosca:Definitions")
@XmlAccessorType(XmlAccessType.PUBLIC_MEMBER)
public static class Definitions {

@XmlElement(name = "tosca:ArtifactType", required = true)
public ArtifactType artifactType;

@XmlAttribute(name = "xmlns:tosca", required = true)
public static final String tosca="http://docs.oasis-open.org/tosca/ns/2011/12";
@XmlAttribute(name = "xmlns:winery", required = true)
public static final String winery="http://www.opentosca.org/winery/extensions/tosca/2013/02/12";
@XmlAttribute(name = "xmlns:ns0", required = true)
public static final String ns0="http://www.eclipse.org/winery/model/selfservice";
@XmlAttribute(name = "id", required = true)
public static final String id="winery-defs-for_tbt-RR_ScriptArtifact";
@XmlAttribute(name = "targetNamespace", required = true)
public static final String targetNamespace="http://docs.oasis-open.org/tosca/ns/2011/12/ToscaBaseTypes"; 

public Definitions() {
artifactType = new ArtifactType();
}

public static class ArtifactType {
@XmlAttribute(name = "name", required = true)
public static final String name = "RR_ScriptArtifact";
@XmlAttribute(name = "targetNamespace", required = true)
public static final String targetNamespace="http://docs.oasis-open.org/tosca/ns/2011/12/ToscaBaseTypes"; 
ArtifactType() {}
}
}


}
\end{lstlisting}
\end{Listing}

\begin{Listing} 
	\caption{Generate definition for Script Artifact Type}
	\label{lst:scripttype_create}
	\begin{lstlisting}
// output filename
public static final String filename = "RR_ScriptArtifact.tosca";

/**
* Create ScriptType xml description
* 
* @param cr
* @throws JAXBException
* @throws IOException
*/
public static void init(Control_references cr) throws JAXBException,
IOException {
	File dir = new File(cr.getFolder() + Control_references.Definitions);
	dir.mkdirs();
	File temp = new File(cr.getFolder() + Control_references.Definitions + filename);
	if (temp.exists())
	temp.delete();
	temp.createNewFile();
	OutputStream output = new FileOutputStream(cr.getFolder()
	+ Control_references.Definitions + filename);
	
	JAXBContext jc = JAXBContext.newInstance(Definitions.class);
	
	Definitions shema = new Definitions();
	
	Marshaller marshaller = jc.createMarshaller();
	marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);
	marshaller.marshal(shema, output);
	cr.metaFile.addFileToMeta(Control_references.Definitions + filename, "application/vnd.oasis.tosca.definitions");
}
\end{lstlisting}
\end{Listing}
\begin{Listing}
\caption{Abstract language model}
\label{lst:langabst}
\begin{lstlisting}
public abstract class Language {
	
	// List of package managers supported by language
	protected List<PacketManager> packetManagers;
	
	// Extensions for this language
	protected List<String> extensions;
	
	// Language Name
	protected String Name;
	
	// To access package topology
	protected Control_references cr;
	
	// List with already created packages
	protected List <String> created_packages;

	/**	Generate node name for specific packages
	* @param packet
	* @param source
	* @return
	*/
	public abstract String getNodeName(String packet, String source);
	
	
	/**	Generate Node for TOSCA Topology
	* @param packet
	* @param source
	* @return
	* @throws IOException
	* @throws JAXBException
	*/
	public abstract String createTOSCA_Node(String packet, String source) throws IOException, JAXBException;
}
\end{lstlisting}
\end{Listing}

\begin{Listing}
\caption{Abstract package manager model}
\label{lst:pmabst}
\begin{lstlisting}
public abstract class PacketManager {

// Name of manager
static public String Name;

protected Language language;

protected Control_references cr;

/**
* Proceed given file with different source (like archive)
* 
* @param filename
* @param cr
* @param source
* @throws FileNotFoundException
* @throws IOException
* @throws JAXBException
*/
public abstract void proceed(String filename, String source) throws FileNotFoundException, IOException,
JAXBException;
}
\end{lstlisting}
\end{Listing}

\begin{Listing}
\caption{Create TOSCA node for bash language}
\label{lst:create_bash}
\begin{lstlisting}
	public String createTOSCA_Node(String packet, String source) throws IOException, JAXBException{
if(created_packages.contains(packet+"+"+source))
return packet;
created_packages.add(packet+"+"+source);
packet = getNodeName(packet, source);
RR_NodeType.createNodeType(cr, packet);
RR_ScriptArtifactTemplate.createScriptArtifact(cr, packet);
RR_PackageArtifactTemplate.createPackageArtifact(cr, packet);
RR_TypeImplementation.createNT_Impl(cr, packet);
return packet;
}
\end{lstlisting}
\end{Listing}

%\begin{Listing}
%\begin{lstlisting}[caption={Create TOSCA node for bash language}\label{lst:create_bash},captionpos=t] 
%\end{lstlisting}
%\end{Listing}

\begin{Listing}
\caption{File parsing for Bash + apt-get }
\label{lst:bash_apt_parse}
\begin{lstlisting}
public void proceed(String filename, String source)
throws IOException, JAXBException {
String prefix = "";
for (int i = 0; i < Utils.getPathLength(filename) - 1; i++)
prefix = prefix + "../";
if (cr == null)
throw new NullPointerException();
System.out.println(Name + " proceed " + filename);
BufferedReader br = new BufferedReader(new FileReader(filename));
boolean isChanged = false;
String line = null;
String newFile = "";
while ((line = br.readLine()) != null) {
// split string to words
String[] words = line.replaceAll("[;&]", "").split("\\s+");
// skip space at the beginning of string
int i = 0;
if (words[i].equals(""))
i = 1;
// look for apt-get
if (words.length >= 1 + i && words[i].equals("apt-get")) {
// apt-get found
if (words.length >= 3 + i && words[1 + i].equals("install")) {
// replace "apt-get install" by "dpkg -i"
System.out.println("apt-get found:" + line);
isChanged = true;
for (int packet = 2 + i; packet < words.length; packet++) {
System.out.println("packet: " + words[packet]);
//							cr.AddDependenciesScript(source, words[packet]);
cr.getPacket(language, words[packet], source);
}
}
newFile += "#//References resolver//" + line + '\n';
} else
newFile += line + '\n';
}
br.close();
if (isChanged) {
// references found, need to replace file
// delete old
File file = new File(filename);
file.delete();

// create new file
FileWriter wScript = new FileWriter(file);
wScript.write(newFile, 0, newFile.length());
wScript.close();
}
}
\end{lstlisting}
\end{Listing}

\begin{Listing}
\caption{Ansible proceeding}
\label{lst:ansible_proceed}
\begin{lstlisting}
	public void proceed(Control_references cr) throws FileNotFoundException,
IOException, JAXBException {
	if (cr == null)
	throw new NullPointerException();
	for (String f : cr.getFiles())
	for (String suf : extensions)
	if (f.toLowerCase().endsWith(suf.toLowerCase())) {
		if (suf.equals(".zip")) {
			proceedZIP(f);
		} else
		proceed(f, f);
	}
}

/**
* proceed given file
* 
* @param filename
* @param cr
* @param source
*            of file, example - archive
* @throws FileNotFoundException
* @throws IOException
* @throws JAXBException
*/
public void proceed(String filename, String source)
throws FileNotFoundException, IOException, JAXBException {
	for (PacketManager pm : packetManagers)
	pm.proceed(filename, source);
}

/**
* Handle ZIP package
* 
* @param zipfile
* @throws FileNotFoundException
* @throws IOException
* @throws JAXBException
*/
private void proceedZIP(String zipfile) throws FileNotFoundException,
IOException, JAXBException {
	boolean isChanged = false;
	// String filename = new File(f).getName();
	String folder = new File(cr.getFolder() + zipfile).getParent()
	+ File.separator + "temp_RR_ansible_folder" + File.separator;
	List<String> files = zip.unZipIt(cr.getFolder() + zipfile, folder);
	for (String file : files)
	if (file.toLowerCase().endsWith("yml"))
	proceed(folder + file, zipfile);
	if (isChanged) {
		new File(cr.getFolder() + zipfile).delete();
		zip.zipIt(cr.getFolder() + zipfile, folder);
	}
	zip.delete(new File(folder));
	
}
\end{lstlisting}
\end{Listing}